(window.webpackJsonp=window.webpackJsonp||[]).push([[2],{45:function(e,t,o){"use strict";o.r(t);var n=o(0),s=function(e){var t,o,n,s,a,r=(t="YikesScript",s=void 0,a="TypeScript",(o={}).type=n="post",o.internal=s,o.contentType="markdown",o.slug=t,o.content=s,o.createdAt=new Date(1632528e6),o.updatedAt=new Date(1663773356711),o.layout=n,o.title=t,o.date="2021-9-25",o.tags=[a],o.markdownHeadings=[{text:t,slug:"yikesscript",level:1}],o.excerpt="<p>Recently at work an seemingly innocuous dependecy bump caused a rash of typescript errors to appear throughout our code base. The changes seemed benign -  a new method in an internal library and a few dependabot updates to go with it. Nothing, it seemed, that should cause <em>these</em> errors:</p>\n",o.permalink="/posts/YikesScript.html",o.assets={},o.attributes=o,o.tagsInfo=[{name:a,permalink:"/tags/typescript"}],o),i=e.options.beforeCreate||[];e.options.beforeCreate=[function(){this.$page=r}].concat(i);["layout","transition"].forEach((function(t){var o=e.options.PageComponent;o&&(e.options[t]=o[t]),void 0===e.options[t]&&(e.options[t]=r[t])})),r.slug&&(e.options.name="page-wrapper-"+r.slug.replace(/[^0-9a-z\-]/gi,"-"))},a=Object(n.a)({},(function(){var e=this,t=e.$createElement,o=e._self._c||t;return o("layout-manager",[o("h1",{attrs:{id:"yikesscript"}},[e._v("YikesScript")]),e._v(" "),o("p",[e._v("Recently at work an seemingly innocuous dependecy bump caused a rash of typescript errors to appear throughout our code base. The changes seemed benign -  a new method in an internal library and a few dependabot updates to go with it. Nothing, it seemed, that should cause "),o("em",[e._v("these")]),e._v(" errors:")]),e._v(" "),o("div",{pre:!0,attrs:{class:"saber-highlight","data-lang":""}},[o("pre",{pre:!0,attrs:{class:"saber-highlight-code language-text"}},[o("code",{pre:!0,attrs:{class:"language-text"}},[e._v("src/****************.tsx:94:17 - error TS2550: Property 'allSettled'\ndoes not exist on type 'PromiseConstructor'. \nDo you need to change your target library?\nTry changing the 'lib' compiler option to 'es2020' or later.\n\n94   await Promise.allSettled(")])])]),o("p",[e._v("and")]),e._v(" "),o("div",{pre:!0,attrs:{class:"saber-highlight","data-lang":""}},[o("pre",{pre:!0,attrs:{class:"saber-highlight-code language-text"}},[o("code",{pre:!0,attrs:{class:"language-text"}},[e._v("src/****************.ts:105:31 - error TS2550: Property 'flatMap'\ndoes not exist on type '{ [key: string]: { [quay: string]: Value;\n}; }[]'. \nDo you need to change your target library? \nTry changing the 'lib' compiler option to 'es2019' or later.\n\n105   return Object.values(cache).flatMap((value) =>\n                                  ~~~~~~~")])])]),o("p",[e._v("We went through the new code with a fine tooth comb - there was\nnothing that explained the appearance of there errors, and TypeScript's suggestion\nto \"Try changing the 'lib' compiler option to 'es2020' or later.\"\ninstantly fixed all our compilation woes. This was unsatisfying - these changes didn't\ntouch our typescript config. It made no sense.")]),e._v(" "),o("p",[e._v("Clearly something was amiss, the code was compiling before even\nthough it used features that our tsconfig did not support.\nReally it seemed like we were just seeing errors that should\nalready have been spotted.")]),e._v(" "),o("p",[e._v("At a loss, I did what I always do when looking for inspiration - I\nstart scanning through the diff of our package.lock file. I noted\nwhich packages had changed. One jumped out - type-fest, a dependecny\nof a dependency of a dependency. It provides random utility types\nand it had been upgraded from "),o("code",{pre:!0},[e._v("v0.20.2")]),e._v(" to "),o("code",{pre:!0},[e._v("0.21.3")]),e._v(". Why did it\njump out at me? I guess because we were seeing type errors, and it\ncontained the word type. I had no other reason to think it was\nresponsible as the effected code didn't use type-fest.")]),e._v(" "),o("p",[e._v("I navigated to github dot com - and felt slightly sick when I saw\nthat the latest version of type fest was "),o("code",{pre:!0},[e._v("v2.3.2")]),e._v('. I started reading\nthrough the changelog. I could taste copper in my mouth, and there\nwas an ozone smell in the air. It was a slog through boring\ndescriptions like "Fix export for '),o("code",{pre:!0},[e._v("Get")]),e._v(" type\n("),o("saber-link",{attrs:{to:"https://github.com/sindresorhus/type-fest/pull/181"}},[e._v("#181")]),e._v(")\n"),o("saber-link",{attrs:{to:"https://github.com/sindresorhus/type-fest/commit/a65377be2fba48165c9514301b679d1f21171dbd"}},[e._v("a65377b")]),e._v('"\nand "Reticulate Splines\n('),o("saber-link",{attrs:{to:"https://github.com/sindresorhus/type-fest/pull/181"}},[e._v("#184")]),e._v(") "),o("saber-link",{attrs:{to:"https://github.com/sindresorhus/type-fest/commit/g87244nbe2fba48165c9514301b679d1f21171dbd"}},[e._v("g87244n")]),e._v('".\nI wondered what the point of this library was. Then I noticed it.\nSticking out, a strange a warped PR title. "Fix TS type reference\n('),o("saber-link",{attrs:{to:"https://github.com/sindresorhus/type-fest/pull/187"}},[e._v("#187")]),e._v(")\n"),o("saber-link",{attrs:{to:"https://github.com/sindresorhus/type-fest/commit/ed5f3d360fc9e9275dfc193cfc3992f11e192c3c"}},[e._v("ed5f3d3")]),e._v('".\nWith a growing sense of unease I clicked the link, and through half narrowed eyes peered into the the diff. I saw this.')],1),e._v(" "),o("div",{pre:!0,attrs:{class:"saber-highlight","data-lang":""}},[o("pre",{pre:!0,attrs:{class:"saber-highlight-code language-text"}},[o("code",{pre:!0,attrs:{class:"language-text"}},[e._v('- /// <reference lib="esnext"/>\n+ /// <reference lib="es2020.bigint"/>')])])]),o("p",[e._v("Strange - I thought. This is TypeScript related. But surely this wouldn't effect how completely unrelated code was compiled? I relaxed a little. Still not entirely reassured I decided to do a test to confirm that these changes weren't responsible. I perfomed some manual node_module surgery and reverted the change. To my utter horror everything instantly compiled. The acrid stench of chemicals in the air grew stronger. Black specks appeared in the corners of my vision. Somehow this tiny change was the root of my problems.")]),e._v(" "),o("p",[e._v("I had to understand what was going on. I read the "),o("saber-link",{attrs:{to:"https://github.com/sindresorhus/type-fest/pull/187"}},[e._v("PR related to this change")]),e._v(" which led me to "),o("saber-link",{attrs:{to:"https://github.com/microsoft/TypeScript/issues/33901"}},[e._v("this typescript issue")]),e._v(". The awful words I read swam and wavered under my eyes.")],1),e._v(" "),o("blockquote",[o("p",[o("strong",[e._v("Expected behavior")]),e._v(": should produce a compile error")])]),e._v(" "),o("blockquote",[o("p",[o("strong",[e._v("Actual behavior:")]),o("br"),e._v("\nIt just compiles.")])]),e._v(" "),o("p",[e._v("Yet then there was worse to come. The increasingly illegible monospace\nfont  explained how any typescript dependency could accidentally\nor maliciously subvert the expectations of the poor fool that choose\nto use it.")]),e._v(" "),o("blockquote",[o("p",[e._v("This is what a lib reference "),o("em",[e._v("does")]),e._v(".")])]),e._v(" "),o("blockquote",[o("p",[e._v("This issue has been marked 'Working as Intended' and has seen no recent activity. It has been automatically closed for house-keeping purposes.")])]),e._v(" "),o("p",[e._v("I slammed shut the accursed tome - it dropped from my hands and hit\nthe floor with a crash that seemed impossible given it's relatively\nlight weight. It sat inert on the floor, powerless I thought, yet\nstill I felt almost like it was watching me. Now I understand what\nthe scorch marks on the cover meant - whoever was here before me\nhad tried to destroy this awful knowledge - before it could it drive\nanother to madness. It's too late for me now - but surely I can\nfinish my precursors work and destroy the cursed thing before I\nlose my grasp entirely. Tonight  before they come for me I'll sink it\nin in the lake. I can here them approaching now - it's not too late\nthough. If I can just")])])}),[],!1,null,null,null);"function"==typeof s&&s(a);t.default=a.exports}}]);